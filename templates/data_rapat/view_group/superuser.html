<script>
    document.addEventListener("DOMContentLoaded", function () {
        function formatRupiah(amount) {
            try {
                const num = parseFloat(amount) || 0;
                return num.toLocaleString('id-ID'); // Otomatis jadi 1.000.000
            } catch (e) {
                return "0";
            }
        }

        function formatDate(idDate) {
            if (!idDate) return "";

            const date = new Date(idDate);
            if (isNaN(date)) return idDate;

            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return new Intl.DateTimeFormat('id-ID', options).format(date);
        }

        function formatTime(timeStr) {
            if (!timeStr) return "";

            if (typeof timeStr === "string") {
                const parts = timeStr.split(":");
                return `${parts[0]}:${parts[1]}`;
            }

            if (timeStr instanceof Date) {
                const hours = timeStr.getHours().toString().padStart(2, '0');
                const minutes = timeStr.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            return timeStr;
        }

        var table = new Tabulator("#tabel_data_rapat", {
            layout: "fitColumns",
            responsiveLayout: "collapse",
            ajaxURL: "{% url 'data_rapat_api' %}",
            placeholder: "Data tidak tersedia",
            ajaxConfig: "GET",
            pagination: true,
            paginationMode: "remote",
            paginationSize: 10,
            paginationCounter: "rows",

            columns: [
                {
                    title: "NO",
                    field: "no",
                    hozAlign: "center",
                    headerHozAlign: "center",
                    formatter: function (cell) {
                        let page = cell.getTable().getPage();
                        let pageSize = cell.getTable().getPageSize();
                        return (page - 1) * pageSize + cell.getRow().getPosition(true);
                    },

                },
                {
                    title: "Tanggal",
                    field: "tanggal",
                    headerHozAlign: "center",
                    hozAlign: "center",
                    formatter: function (cell) {
                        return formatDate(cell.getValue());
                    },
                    headerFilter:"input",
                    headerFilterPlaceholder: "2025-01-30"
                },
                {
                    title: "Jam ",
                    field: "jam",
                    headerHozAlign: "center",
                    hozAlign: "center",
                    formatter: function (cell) {
                        return formatTime(cell.getValue());
                    }
                },
                { title: "Nama", field: "nama", headerHozAlign: "center" , headerFilter:"input" },
                { title: "Surat", field: "judul_surat", headerHozAlign: "center" , headerFilter:"input" },
                { title: "Kontrak", field: "judul_kontrak", headerHozAlign: "center" , headerFilter:"input" },
                { title: "No BAST", field: "no_bast", headerHozAlign: "center" , headerFilter:"input" },


                {
                    title: "BAST",
                    field: "file_bast",
                    hozAlign: "center",
                    headerHozAlign: "center",
                    formatter: function(cell) {
                        const fileUrl = cell.getValue();

                        if (!fileUrl) {
                            return `
                                <div class="flex items-center justify-center h-full">
                                    <span class="text-gray-400 text-xs">Tidak ada</span>
                                </div>
                            `;
                        }
                        return `
                              <div class="flex items-center justify-center h-full cursor-pointer">
                               <svg class="w-6 h-6 text-yellow-300 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 17v-5h1.5a1.5 1.5 0 1 1 0 3H5m12 2v-5h2m-2 3h2M5 10V7.914a1 1 0 0 1 .293-.707l3.914-3.914A1 1 0 0 1 9.914 3H18a1 1 0 0 1 1 1v6M5 19v1a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-1M10 3v4a1 1 0 0 1-1 1H5m6 4v5h1.375A1.627 1.627 0 0 0 14 15.375v-1.75A1.627 1.627 0 0 0 12.375 12H11Z"/>
                               </svg>
                            </div>
                        `;
                    },
                    cellClick: function(e, cell) {
                        const fileUrl = cell.getValue();
                        if (fileUrl) window.open(fileUrl, '_blank'); // âœ… Berhasil buka file
                    }
                },
                {
                    title: "Masuk",
                    field: "kas_masuk",
                    headerHozAlign: "center",
                    hozAlign: "right",
                    formatter: function (cell) {
                        return formatRupiah(cell.getValue());
                    }
                },
                {
                    title: "Keluar",
                    field: "kas_keluar",
                    headerHozAlign: "center",
                    hozAlign: "right",
                    formatter: function (cell) {
                        return formatRupiah(cell.getValue());
                    }
                },
                {
                    title: "AKSI",
                    field: "actions",
                    hozAlign: "center",
                    headerHozAlign: "center",
                    formatter: function (cell) {
                        const rowData = cell.getRow().getData();
                        return `
                                                <div class="flex space-x-2 justify-center gap-2">
                                                    <button 
                                                        data-modal-target="edit_data_rapat${rowData.id}" 
                                                        data-modal-toggle="edit_data_rapat${rowData.id}" 
                                                        class="edit_data_rapat bg-green-600 hover:bg-green-800 text-white font-bold py-1 px-2 rounded focus:ring-4 focus:ring-green-300" 
                                                        title="Edit Data">
                                                         <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                                        </svg>
                                                    </button>
                                                    <button 
                                                        data-modal-target="edit_nominal${rowData.id}" 
                                                        data-modal-toggle="edit_nominal${rowData.id}" 
                                                        class="edit_nominal bg-yellow-600 hover:bg-yellow-800 text-white font-bold py-1 px-2 rounded focus:ring-4 focus:ring-yellow-300" 
                                                        title="Edit Nominal">
                                                        <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17.345a4.76 4.76 0 0 0 2.558 1.618c2.274.589 4.512-.446 4.999-2.31.487-1.866-1.273-3.9-3.546-4.49-2.273-.59-4.034-2.623-3.547-4.488.486-1.865 2.724-2.899 4.998-2.31.982.236 1.87.793 2.538 1.592m-3.879 12.171V21m0-18v2.2"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            `;
                    },
                    cellClick: function(e, cell) {
                        const rowData = cell.getRow().getData();
                        const btn = e.target.closest("button");

                        if (!btn) return;

                        const isEditData = btn.classList.contains("edit_data_rapat");
                        const isEditNominal = btn.classList.contains("edit_nominal");

                        if (isEditData) {
                            const modal = document.getElementById(`edit_data_rapat${rowData.id}`);
                            if (modal) new Modal(modal).show();
                        }

                        if (isEditNominal) {
                            const modal = document.getElementById(`edit_nominal${rowData.id}`);
                            if (modal) new Modal(modal).show();
                        }
                    }
                }

            ]
        });
    });
</script>


