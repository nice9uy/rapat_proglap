{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}

{% block data_rapat %}
    <div class="antialiased bg-gray-800  ">
        {% include 'components/header_data_rapat.html' %}
        <div class="p-4 pt-20">
            <div class="flex text-white text-2xl justify-between">
                <div class="">
                    DATA RAPAT
                </div>
                <button data-modal-target="tambah_rapat" data-modal-toggle="tambah_rapat" class="block text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
                    TAMBAH RAPAT
                </button>
            </div>

            <div class="mt-3" id="tabel_data_rapat"></div>
            <div class="mx-auto">
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        function formatRupiah(amount) {
                            try {
                                const num = parseFloat(amount) || 0;
                                return num.toLocaleString('id-ID'); // Otomatis jadi 1.000.000
                            } catch (e) {
                                return "0";
                            }
                        }

                        function formatDate(idDate) {
                            if (!idDate) return "";

                            const date = new Date(idDate);
                            if (isNaN(date)) return idDate;

                            const options = { day: 'numeric', month: 'long', year: 'numeric' };
                            return new Intl.DateTimeFormat('id-ID', options).format(date);
                        }

                        function formatTime(timeStr) {
                            if (!timeStr) return "";

                            if (typeof timeStr === "string") {
                                const parts = timeStr.split(":");
                                return `${parts[0]}:${parts[1]}`;
                            }

                            if (timeStr instanceof Date) {
                                const hours = timeStr.getHours().toString().padStart(2, '0');
                                const minutes = timeStr.getMinutes().toString().padStart(2, '0');
                                return `${hours}:${minutes}`;
                            }

                            return timeStr;
                        }

                        var table = new Tabulator("#tabel_data_rapat", {
                            layout: "fitColumns",
                            responsiveLayout: "collapse",
                            ajaxURL: "{% url 'data_rapat_api' %}",
                            placeholder: "Data tidak tersedia",
                            ajaxConfig: "GET",
                            pagination: true,
                            paginationMode: "remote",
                            paginationSize: 15,
                            paginationCounter: "rows",

                            columns: [
                                {
                                    title: "NO",
                                    field: "no",
                                    hozAlign: "center",
                                    headerHozAlign: "center",
                                    formatter: function (cell) {
                                        let page = cell.getTable().getPage();
                                        let pageSize = cell.getTable().getPageSize();
                                        return (page - 1) * pageSize + cell.getRow().getPosition(true);
                                    },
                                    width: 60,
                                },
                                {
                                    title: "Tanggal",
                                    field: "tanggal",
                                    headerHozAlign: "center",
                                    hozAlign: "center",
                                    formatter: function (cell) {
                                        return formatDate(cell.getValue());
                                    }
                                },
                                {
                                    title: "Jam Rapat",
                                    field: "jam",
                                    headerHozAlign: "center",
                                    hozAlign: "center",
                                    formatter: function (cell) {
                                        return formatTime(cell.getValue());
                                    }
                                },
                                { title: "Nama", field: "nama", headerHozAlign: "center" },
                                { title: "Kontrak", field: "judul_kontrak", headerHozAlign: "center" },
                                {
                                    title: "Masuk",
                                    field: "kas_masuk",
                                    headerHozAlign: "center",
                                    hozAlign: "right",
                                    formatter: function (cell) {
                                        return formatRupiah(cell.getValue());
                                    }
                                },
                                {
                                    title: "Keluar",
                                    field: "kas_keluar",
                                    headerHozAlign: "center",
                                    hozAlign: "right",
                                    formatter: function (cell) {
                                        return formatRupiah(cell.getValue());
                                    }
                                },
                                {
                                    title: "AKSI",
                                    field: "actions",
                                    hozAlign: "center",
                                    headerHozAlign: "center",
                                    formatter: function (cell) {
                                        const rowData = cell.getRow().getData();
                                        return `
                                                <div class="flex space-x-2 justify-center gap-2">
                                                    <button 
                                                        data-modal-target="edit_data_rapat${rowData.id_random}" 
                                                        data-modal-toggle="edit_data_rapat${rowData.id_random}" 
                                                        class="edit_data_rapat bg-green-600 hover:bg-green-800 text-white font-bold py-1 px-2 rounded focus:ring-4 focus:ring-green-300" 
                                                        title="Edit Data">
                                                        <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11.917 9.724 16.5 19 7.5"/>
                                                        </svg>
                                                    </button>
                                                    <button 
                                                        data-modal-target="edit_nominal${rowData.id_random}" 
                                                        data-modal-toggle="edit_nominal${rowData.id_random}" 
                                                        class="edit_nominal bg-yellow-600 hover:bg-yellow-800 text-white font-bold py-1 px-2 rounded focus:ring-4 focus:ring-yellow-300" 
                                                        title="Edit Nominal">
                                                        <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            `;
                                    },
                                    cellClick: function(e, cell) {
                                        const rowData = cell.getRow().getData();
                                        const btn = e.target.closest("button");

                                        if (!btn) return;

                                        const isEditData = btn.classList.contains("edit_data_rapat");
                                        const isEditNominal = btn.classList.contains("edit_nominal");

                                        if (isEditData) {
                                            const modal = document.getElementById(`edit_data_rapat${rowData.id_random}`);
                                            if (modal) new Modal(modal).show();
                                        }

                                        if (isEditNominal) {
                                            const modal = document.getElementById(`edit_nominal${rowData.id_random}`);
                                            if (modal) new Modal(modal).show();
                                        }
                                    }
                                }
                            ]
                        });
                    });
                </script>
            </div>
        </div>
        {% include 'data_rapat/modal/tambah.html' %}
        {% include 'data_rapat/modal/edit_rapat.html' %}
        {% include 'data_rapat/modal/edit_nominal.html' %}


{% endblock %}
